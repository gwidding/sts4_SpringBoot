<!DOCTYPE html>
<html lang="kor">
<head>
	<title>Shoping Cart</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<!--===============================================================================================-->	
	<link rel="icon" type="image/png" href="images/icons/favicon.png"/>
	<link rel="stylesheet" type="text/css" href="css/combined-style.css">
<!--===============================================================================================-->
</head>
<body class="animsition">
	
	<!-- Header -->
	<header class="header-v4">
		<!-- Header Desktop -->
		<div th:replace="~{fragments/common :: header}"></div>
		<!-- Header Mobile -->
		<div th:replace="~{fragments/common :: mobile}"></div>
		 <!-- search-modal -->
    	<div th:replace="~{fragments/common :: search-modal}"></div>
	</header>
	
	<!-- Cart Slide -->
	<div th:replace="~{fragments/common :: cart}"></div>

	<!-- breadcrumb -->
	<div class="container">
		<div class="bread-crumb flex-w p-l-25 p-r-15 p-t-30 p-lr-0-lg">
			<a href="/home" class="stext-109 cl8 hov-cl1 trans-04">
				Home
				<i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
			</a>

			<span class="stext-109 cl4">
				Shopping Cart
			</span>
		</div>
	</div>
		

	<!-- Shoping Cart -->
	<div class="bg0 p-t-75 p-b-85" th:with="subTotal=${#aggregates.sum(cartList.![(pprice * quantity)]) }">
		<div class="container">
			<div class="row">
				<div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
					<div class="m-l-25 m-r--38 m-lr-0-xl">
						<div class="wrap-table-shopping-cart">
							<table class="table-shopping-cart">
								<tr class="table_head">
									<th class="column-1">Product</th>
									<th class="column-2"></th>
									<th class="column-3">Price</th>
									<th class="column-4">Quantity</th>
									<th class="column-5">Total</th>
								</tr>

								<div th:if="${not #lists.isEmpty(cartList)}" th:each="cart, iterStat : ${cartList}">
									<tr class="table_row" >
										<td class="column-1">
											<div class="how-itemcart1">
											<div class="how-itemcart1">
												<img th:if="${cart.imgName == null or cart.imgPath == null}" th:onclick="deleteCart([[ ${cart.cartId} ]])" src="images/item-cart-01.jpg" alt="IMG">
												<img th:unless="${cart.imgName == null or cart.imgPath == null}" th:onclick="deleteCart([[ ${cart.cartId} ]])" th:src="${cart.imgPath + cart.imgName}" alt="IMG">
											</div>
										</td>
										<td class="column-2"><a th:href="@{/product-detail(productId=${cart.productId})}" th:text="${cart.pname}"></a></td>
										<td class="column-3" th:id="'pprice' + ${iterStat.index + 1}" th:text="${#numbers.formatInteger(cart.pprice,3,'COMMA') + '원'}"></td>
										<td class="column-4" th:id="'num-product' + ${iterStat.index + 1}" th:text="'X ' + ${cart.quantity}"></td>
										<td class="column-5">
											<span th:id="'totalAmount' + ${iterStat.index + 1}" th:text="${#numbers.formatInteger((cart.pprice * cart.quantity),3,'COMMA') + '원'}"></span>
										</td>
									</tr>

									<tr th:if="${cart.stock < 1 }">
										<td class="column-2">매진된 상품입니다.</td>
									</tr>

									<tr th:if="${cart.stock > 0 and cart.stock - cart.quantity < 0}">
									<td class="column-6">선택한 수량보다 재고가 부족합니다.</td>
									</tr>
								</div>
								
								<tr class="table_row" th:unless="${not #lists.isEmpty(cartList)}">
									<td class="column-2"> 장바구니가 비었습니다. </td>
								</tr>
							</table>
						</div>
					</div>
				</div>

				<div class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50" th:if="${not #lists.isEmpty(cartList)}">
					<div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
						<h4 class="mtext-109 cl2 p-b-30">
							Cart Totals
						</h4>
						<form th:action="@{/cart/order}" method="post" th:object="${newOrder}">

							<div class="flex-w flex-t bor12 p-b-13">
								<div class="size-208">
									<span class="stext-110 cl2"> Subtotal: </span>
								</div>
	
								<div class="size-209">
									<span class="mtext-110 cl2" th:text="${#numbers.formatInteger(subTotal,3,'COMMA') + '원'}"></span>
									<input type="hidden" name="price" th:value="${subTotal}" />
									<input type="hidden" th:if="${memberInfo != null}" name="memberIdx" th:value="${memberInfo.idx}" />
								</div>
							</div>
	
							<div class="flex-w flex-t bor12 p-t-15 p-b-30">
								<div class="size-208 w-full-ssm">
									<span class="stext-110 cl2"> 기본 주소: </span>
								</div>
	
								<div class="size-209 p-r-18 p-r-0-sm w-full-ssm">
									<span class="stext-111 c16 p-t-2" th:text="${memberInfo.addr}" name="state"></span>
									
									<input type="checkbox" id="defaultAddr" onchange="toggleReadOnly()" >
	       							<label for="defaultAddr" class="stext-112 c18">기본 배송지로 주문</label>
	       							
	       							<div class="bor8 bg0 m-b-12">
										<input class="stext-111 c18 plh3 size-111 p-lr-15" type="text" id="addrInput" name="orderAddr" th:value="${memberInfo.addr}" onclick="findAddr()"/>
									</div>
									
									<div class="p-t-15" th:object="${memberInfo}">
										<span class="stext-112 cl8"> 배송비 무료 </span>
										
										<div class="rs1-select2 bor8 bg0">
												<select class="js-select2" name="orderNotes" th:field="${newOrder.orderNotes}">
													<option value="">배송메모를 선택해주세요.</option>
													<option value="택배함에 놔주세요.">택배함에 놔주세요.</option>
													<option value="경비실에 맡겨주세요.">경비실에 맡겨주세요.</option>
													<option value="배송 전에 미리 연락 바랍니다.">배송 전에 미리 연락 바랍니다.</option>
													<option value="부재 시 집 앞에 놔주세요.">부재 시 집 앞에 놔주세요.</option>
												</select>
												<div class="dropDownSelect2"></div>
											</div>
										
										<div class="rs1-select2 bor8 bg0">
											<select class="js-select2" name="paymentMethod" th:field="${newOrder.paymentMethod}">
												<option value="" disabled selected hidden>결제 방식을 선택하세요</option>
												<option value="신용카드">신용카드</option>
												<option value="계좌이체">계좌이체</option>
												<option value="무통장입금">무통장 입금</option>
											</select>
											<div class="dropDownSelect2"></div>
										</div>
											
									</div>
								</div>
							</div>
	
							<div class="flex-w flex-t p-t-27 p-b-33">
								<div class="size-208">
									<span class="mtext-101 cl2"> Total: </span>
								</div>
	
								<div class="size-209 p-t-1">
									<span class="mtext-110 cl2" th:text="${#numbers.formatInteger(subTotal,3,'COMMA') + '원'}"> </span>
								</div>
							</div>
	
							<button type="submit" class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer">
								바로 구매
							</button>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<!-- Footer -->
	<div th:replace="~{fragments/common :: footer}"></div>
	<!-- Back-To-Top -->
	<div th:replace="~{fragments/common :: back-to-top}"></div>

<!--===============================================================================================-->	
	<script src="vendor/jquery/jquery-3.2.1.min.js"></script>
	<script src="vendor/animsition/js/animsition.min.js"></script>
	<script src="vendor/bootstrap/js/popper.js"></script>
	<script src="vendor/bootstrap/js/bootstrap.min.js"></script>
	<script src="vendor/select2/select2.min.js"></script>
	
	<script>
	    // 페이지 로드 시 실행되는 함수
	    window.onload = function() {
	        // 추가할 클래스와 대상 요소의 id
	        var className = 'active-menu';
	        var targetId = 'li-cart'; // 여러분이 원하는 id로 변경하세요.
	
	        // 대상 요소 찾기
	        var targetElement = document.getElementById(targetId);
	
	        // 대상 요소가 존재하는 경우 클래스 추가
	        if (targetElement) {
	            targetElement.classList.add(className);
	        }
	    };
	</script>
	
	<script>
		$(".js-select2").each(function(){
			$(this).select2({
				minimumResultsForSearch: 20,
				dropdownParent: $(this).next('.dropDownSelect2')
			});
		})
	</script>

	<script src="vendor/MagnificPopup/jquery.magnific-popup.min.js"></script>
	<script src="vendor/perfect-scrollbar/perfect-scrollbar.min.js"></script>
	
	<script>
		$('.js-pscroll').each(function(){
			$(this).css('position','relative');
			$(this).css('overflow','hidden');
			var ps = new PerfectScrollbar(this, {
				wheelSpeed: 1,
				scrollingThreshold: 1000,
				wheelPropagation: false,
			});

			$(window).on('resize', function(){
				ps.update();
			})
		});
	</script>
<!--===============================================================================================-->
	<script src="js/main.js"></script>	
	<script th:inline="javascript">
		/* <![CDATA[ */

		// 구매 가능 여부 확인 (재고 확인)
		function checkStock(cartId, pname, quantity, stock) {
			if (quantity > stock) {
				alert("재고가 부족하여" + pname + " 상품을 삭제합니다.");
				deleteCart(cartId);
			}
		}
		
		// 장바구니 상품 지우기
		function deleteCart(idx) {
			
			if (confirm(idx + "번 상품을 장바구니에서 삭제하겠습니까?")) {
				var uri = /*[[ @{/cart/delete} ]]*/ null;
				
				// CSRF 토큰 가져오기
	            var csrfParameter = /*[[${_csrf.parameterName}]]*/ '_csrf';
	            var csrfToken = /*[[${_csrf.token}]]*/ null;

				var html = "";
				html += '<form name="dataForm" action="' + uri + '" method="post">';
				html += '<input type="hidden" name="cartId" value="' + idx + '"/>';
				
				 // CSRF 토큰 추가 - 보안
				 html += '<input type="hidden" name="' + csrfParameter + '" value="' + csrfToken + '"/>';
				
				html += '</form>';

				$("body").append(html);
				document.dataForm.submit();
			}
		}
		// 기본 주소인지 확인. 아니면 주소 api
	    function toggleReadOnly() {
		    var isDefault = document.getElementById("defaultAddr");
		    var addrInput = document.getElementById("addrInput");
		
		    if (isDefault.checked) {
				addrInput.value = /*[[ ${memberInfo.addr} ]]*/ null;
		        addrInput.readOnly = true;
		        addrInput.removeAttribute("onclick");
		    } else {
		        addrInput.readOnly = false;
		        addrInput.setAttribute("onclick", "findAddr()");
		    }
		}
		
		/* ]]>*/
	</script>
	
	<!-- 주소 api -->
	<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
	<script>
		function findAddr(){
			new daum.Postcode({
		        oncomplete: function(data) {
		        	
		        	console.log(data);
		        	
		            var roadAddr = data.roadAddress; // 도로명 주소 변수
		            var jibunAddr = data.jibunAddress; // 지번 주소 변수
		            
		            var fullAddress = '';
		            
		            if(roadAddr !== ''){
		                fullAddress += roadAddr;
		            } 
		            else if(jibunAddr !== ''){
		                fullAddress += jibunAddr;
		            }
		            document.getElementById("addrInput").value = fullAddress;
		        }
		    }).open();
	    }
	</script>

</body>
</html>